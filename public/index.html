<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stable 1:1 WebRTC Demo</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="container">
    <h1>Stable 1:1 WebRTC Demo</h1>
    <div id="video-grid">
      <video id="local" autoplay playsinline muted></video>
      <video id="remote" autoplay playsinline></video>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const room = location.hash.substring(1) || prompt("Enter room name:");
    const socket = io();

    let pc;
    let localStream;
    let remoteStream;
    let isOfferer = false;

    async function createPeerConnection() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      remoteStream = new MediaStream();
      document.getElementById("remote").srcObject = remoteStream;

      // Add local tracks again
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => {
          remoteStream.addTrack(track);
        });
      };

      pc.onicecandidate = e => {
        if (e.candidate) {
          socket.emit("signal", { room, data: { candidate: e.candidate } });
        }
      };
    }

    async function startLocalVideo() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("local").srcObject = localStream;
    }

    socket.on("connect", async () => {
      await startLocalVideo();
      socket.emit("join", room);
    });

    socket.on("peer-joined", async () => {
      isOfferer = true;
      await createPeerConnection();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("signal", { room, data: { sdp: pc.localDescription } });
    });

    socket.on("signal", async ({ data }) => {
      if (!pc) await createPeerConnection();

      if (data.sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        if (data.sdp.type === "offer") {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.emit("signal", { room, data: { sdp: pc.localDescription } });
        }
      } else if (data.candidate) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (err) {
          console.error("ICE error", err);
        }
      }
    });

    // When peer leaves (refresh), reset connection
    socket.on("peer-left", async () => {
      if (pc) {
        pc.close();
        pc = null;
      }
      document.getElementById("remote").srcObject = null;
    });
  </script>
</body>
</html>
